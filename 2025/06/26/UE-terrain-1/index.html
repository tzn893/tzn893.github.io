<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>UE4中的地形以及植被系统(1)--地形的编辑 | tzn的小窝</title><meta name="author" content="tzn"><meta name="copyright" content="tzn"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="临近入职，最近mt安排我看一点有关UE4中植被编辑的源码。而植被系统与地形系统又密切相关，因此本人决定一并阅读地形系统以源代码，并将阅读过程中整理出来的信息写成文档（可以显得我这几天干活比较卖力）。本文作为系列的第一篇文章，记录了地形编辑系统基本操作、源码结构；并以Sculpture功能为例，展示了编辑过程中的数据流通过程。 1. 地编系统的基本操作在UE4中地形的编辑需要在landscape模">
<meta property="og:type" content="article">
<meta property="og:title" content="UE4中的地形以及植被系统(1)--地形的编辑">
<meta property="og:url" content="http://example.com/2025/06/26/UE-terrain-1/index.html">
<meta property="og:site_name" content="tzn的小窝">
<meta property="og:description" content="临近入职，最近mt安排我看一点有关UE4中植被编辑的源码。而植被系统与地形系统又密切相关，因此本人决定一并阅读地形系统以源代码，并将阅读过程中整理出来的信息写成文档（可以显得我这几天干活比较卖力）。本文作为系列的第一篇文章，记录了地形编辑系统基本操作、源码结构；并以Sculpture功能为例，展示了编辑过程中的数据流通过程。 1. 地编系统的基本操作在UE4中地形的编辑需要在landscape模">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/ia1.jpg">
<meta property="article:published_time" content="2025-06-26T02:03:14.000Z">
<meta property="article:modified_time" content="2025-06-26T02:23:33.465Z">
<meta property="article:author" content="tzn">
<meta property="article:tag" content="render UE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/ia1.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2025/06/26/UE-terrain-1/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'UE4中的地形以及植被系统(1)--地形的编辑',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-26 10:23:33'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/images/ranran0.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/images/ia1.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="tzn的小窝"><span class="site-name">tzn的小窝</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">UE4中的地形以及植被系统(1)--地形的编辑</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-06-26T02:03:14.000Z" title="发表于 2025-06-26 10:03:14">2025-06-26</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-06-26T02:23:33.465Z" title="更新于 2025-06-26 10:23:33">2025-06-26</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="UE4中的地形以及植被系统(1)--地形的编辑"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p> 临近入职，最近mt安排我看一点有关UE4中植被编辑的源码。而植被系统与地形系统又密切相关，因此本人决定一并阅读地形系统以源代码，并将阅读过程中整理出来的信息写成文档（可以显得我这几天干活比较卖力）。本文作为系列的第一篇文章，记录了地形编辑系统基本操作、源码结构；并以Sculpture功能为例，展示了编辑过程中的数据流通过程。</p>
<h4 id="1-地编系统的基本操作"><a href="#1-地编系统的基本操作" class="headerlink" title="1. 地编系统的基本操作"></a>1. 地编系统的基本操作</h4><p>在UE4中地形的编辑需要在landscape模式下进行。由于我UE的布局和网上大多数教程不一样，并没有Place Actor界面上的Landscape按钮，因此我一般是通过如图所示的modes按钮开启Landscape模式。</p>
<p><img src="/images/ue_terrain_foliage/terrain_1_1.png" alt="image-20250624230537333"></p>
<p>在第一次进入Landscape模式，没有创建任何Landscape的情况下，往往需要创建一个新的landscape。Landscape的创建界面如下图所示。</p>
<p><img src="/images/ue_terrain_foliage/terrain_1_2.png" alt="image-20250624231333049"></p>
<p>可以看到，一个地形对象的mesh被分为3个层级component-section-quad。其中，一个component可以包含多个section而一个section又可以包含多个quad，而一个quad为两个三角形拼成的方形，为构成地形对象的最小单位。</p>
<p>通过mesh确定了顶点的数量以及位置后，可以通过引入外部灰度图来初始化顶点的高度。通过New Landscape下的Import From File选项，可以从外部导入一个灰度图用于更新各个component的高度图。</p>
<p>除此以外，地形队形可以通过不同的material来改变其外观。在Material中，可以通过Landscape Layer Blend节点，为地形添加多个Layer以表现不同地形。</p>
<p>创建好地形后，可以看到引擎提供了三类操作对地形进行编辑：Sculpt、Paint以及Manage。</p>
<p>其中，Sculpt工具可以改变顶点的高度。选择Sculpt工具后，UE编辑器会在场景中生成一个可在场景中移动的笔刷。按住鼠标左键并移动可以使笔刷绘制到对应位置的高度图上，从而影响对应顶点的高度。</p>
<p><img src="/images/ue_terrain_foliage/terrain_1_3.png" alt="image-20250624232514039"></p>
<p>而Paint工具可以使用笔刷绘制到权重图上，以改变对应位置不同Layer之间的权重系数，使地形出现不同的外观表现。</p>
<p><img src="/images/ue_terrain_foliage/terrain_1_4.png" alt="image-20250624233049939"></p>
<p>Manage工具可以实现Landscape Component的增，删以及选中。若整个地形对象只有部分Component选中，则对地形的修改只会应用到被选中的Component上。值得一提的是，我们最开始的创建地形步骤同样属于一个Manage工具。</p>
<p><img src="/images/ue_terrain_foliage/terrain_1_5.png" alt="image-20250624233241361"></p>
<h4 id="2-地编系统的源码结构"><a href="#2-地编系统的源码结构" class="headerlink" title="2. 地编系统的源码结构"></a>2. 地编系统的源码结构</h4><p>以UE4.27的Sculpt工具为例，其地编系统不同类型的UML图如下图所示。</p>
<p><img src="/images/ue_terrain_foliage/terrain_uml.png" alt=""></p>
<p>总的来说，这些类依据功能分为数据存储（<code>ULandscapeComponent</code>等）、输入输出处理（<code>FEdModeLandscape</code>、<code>FLandscapeTool</code> 等）以及数据更新（<code>FLandscapeToolStrokeBase</code>、<code>FLandscapeHeightCache</code> 等），其可以视作分别对应MVC结构中的Model, View以及Control三个部分。</p>
<p>下面将依据MVC的分类具体介绍不同类型的作用。</p>
<p>Model:</p>
<ol>
<li><code>ALandscape</code> / <code>ALandscapeProxy</code>:  对应可以放置在场景中的Actor，其主要由一系列<code>ULandscapeComponent</code>构成。对于外部类主要通过<code>ALandscapeProxy</code> 提供的结构与地形系统中的数据交互。</li>
<li><code>ULandscapeComponent</code> : 对应组成大地形的Component。各个Component中存储了具体的位置信息、顶点数据以及材质信息。同时，由于<code>ULandscapeComponent</code> 继承了<code>UPrimitiveCompnent</code> , 地形系统的渲染数据也由该Component提交。</li>
<li><code>ULandscapeInfo</code> : 在地形编辑系统中，一般通过<code>ULandscapeInfo</code> 对象访问并修改Component中的数据。<code>ULandscapeComponent</code>对象可以通过调用<code>ALandscapeProxy</code>的<code>GetLandscapeInfo()</code> 接口获取，并保存在<code>FEdModeLandscape</code> 对象中，并由<code>FEdModeLandscape</code> 分发给不同的对象编辑。</li>
</ol>
<p>View:</p>
<ol>
<li><code>FEdModeLandscape</code> :  对应UE的Landscape模式。该对象负责处理用户的输入并管理地形编辑工具<code>FLandscapeTool</code>的状态切换。当用户输入事件生成时（如用户点击鼠标左键），编辑器会调用<code>FEdModeLandscape</code>的<code>InputKey</code>接口实现具体的处理逻辑。</li>
<li><code>FLandscapeTool/FLandscapeToolBase</code> : <code>FLandscapeTool</code> 实现了各个Landscape工具的具体逻辑。<code>FEdModeLandscape</code>可以调用<code>FLandscapeTool</code> 的<code>BeginTool()</code> 、<code>EndTool()</code>以及<code>InputKey()</code> 等接口实现Landscape工具的状态切换以及事件处理。而<code>FLandscapeToolBase</code> 在<code>FLandscapeTool</code>  的基础上实现了地形绘制类工具的逻辑。其可以通过指定笔刷实现在地形上的任意绘制。</li>
</ol>
<p>Control:</p>
<ol>
<li><code>FLandscapeToolStroke/FLandScapeToolStrokePaintBase</code> : 对应不同的笔刷类型，负责更新后数据的计算以及更新操作。对于Paint类型的笔刷，通过<code>FToolTarget</code>指定的Data Cache对象来更新数据。这里<code>FToolTarget</code>并不是真实存在的类，而是<code>FLandScapeToolStrokePaintBase</code> 的模板参数，其定义了笔刷类目标对象的数据存储形式是什么（如<code>FToolTarget</code> 可以被指定为<code>FHeightmapToolTarget</code> 来实现对地形高度图的编辑）。由于这里使用了类似type trait的技巧实现了<code>FToolTarget</code> 的编译期多态，因此在UML图中使用了继承结构表现不同类之间的关系。而对于绘图类型的笔刷，可以通过调用Apply接口实现具体数据的计算以及更新。在<code>FLandscapeToolBase</code> 中，该工具在<code>BeginTool()</code> 以及<code>Tick()</code>函数中调用了<code>Apply</code> 接口实现笔刷在地图上的绘制（个人感觉这部分代码过于依赖模板了导致看起来很奇怪）。</li>
<li><code>TLandscapeEditCache/FLandscapeHeightCache</code> ：控制笔刷传输过来的数据更新。由于Component的数据存储在UTexture2D*中，其更新可能涉及CPU以及GPU之间的数据通信，且可能涉及数据存储不连续的问题（笔刷更新的区域跨越了不同的Component）。因此，UE在Component以及Stroke对象之间设计了Cache对象将需要更新的数据缓存下来，待Stroke更新的数据写入结束后一次性将更新的数据输出到Component中。</li>
<li><code>FHeightmapAccessor</code> : Accessor对象负责将数据更新到Component中。其内部保存了由<code>FEdModeLandscape</code> 对象传入的<code>ULandscapeInfo</code> 指针，并通过<code>ULandscapeInfo</code> 计算需要更新的Component以及对应的<code>UTexture2D</code>。随后将Cache对象传入的数据写入到对应Component中实现数据更新。</li>
</ol>
<h4 id="3-地编系统中的数据流"><a href="#3-地编系统中的数据流" class="headerlink" title="3.地编系统中的数据流"></a>3.地编系统中的数据流</h4><p>下面我们将以Sculpt工具为例，刨析从用户鼠标点击事件开始到画面中顶点高度更新结束，数据在地形编辑系统中的流通过程。注意，由于本文只专注地形编辑系统的总体结构，因此不对任何具体算法做任何解析。</p>
<p>在刚进入Landscape Mode时，Landscape Editor Mode会通过当前选中的Landscape Proxy获取对应的Landscape Info，并通过调用<code>SetLandscapeInfo</code> 更新<code>CurrentToolTarget</code>的<code>LandscapeInfo</code>信息。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdMode.cpp line 399</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FEdModeLandscape::Enter</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    ALandscapeProxy* SelectedLandscape = GEditor-&gt;<span class="built_in">GetSelectedActors</span>()-&gt;<span class="built_in">GetTop</span>&lt;ALandscapeProxy&gt;();</span><br><span class="line">    <span class="keyword">if</span> (SelectedLandscape)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">SetLandscapeInfo</span>(SelectedLandscape-&gt;<span class="built_in">GetLandscapeInfo</span>());</span><br><span class="line">        GEditor-&gt;<span class="built_in">SelectNone</span>(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">        GEditor-&gt;<span class="built_in">SelectActor</span>(SelectedLandscape, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        GEditor-&gt;<span class="built_in">SelectNone</span>(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdMode.cpp line 384</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FEdModeLandscape::SetLandscapeInfo</span><span class="params">(ULandscapeInfo* InLandscapeInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (CurrentToolTarget.LandscapeInfo != InLandscapeInfo)</span><br><span class="line">    &#123;</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">TGuardValue&lt;<span class="type">bool</span>&gt; <span class="title">GuardFlag</span><span class="params">(bUpdatingLandscapeInfo, <span class="literal">true</span>)</span></span>;</span><br><span class="line">            CurrentToolTarget.LandscapeInfo = InLandscapeInfo;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>随后当UE检测到用户的输入事件时（如鼠标点击左键），会调用<code>InputKey</code>函数处理，如下面这段代码片段所示。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdMode.cpp line 1761</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FEdModeLandscape::InputKey</span><span class="params">(FEditorViewportClient* ViewportClient, FViewport* Viewport, FKey Key, EInputEvent Event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (NewLandscapePreviewMode != ENewLandscapePreviewMode::None)</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Override Key Input for Selection Brush</span></span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">if</span> (CurrentTool &amp;&amp; CurrentTool-&gt;<span class="built_in">InputKey</span>(ViewportClient, Viewport, Key, Event) == <span class="literal">true</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测用户按下鼠标左键的事件</span></span><br><span class="line">        <span class="keyword">if</span> (Key == EKeys::LeftMouseButton &amp;&amp; Event == IE_Pressed)</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Only activate tool if we&#x27;re not already moving the camera and we&#x27;re not trying to drag a transform widget</span></span><br><span class="line">            <span class="comment">// Not using &quot;if (!ViewportClient-&gt;IsMovingCamera())&quot; because it&#x27;s wrong in ortho viewports :D</span></span><br><span class="line">            <span class="type">bool</span> bMovingCamera = Viewport-&gt;<span class="built_in">KeyState</span>(EKeys::MiddleMouseButton) || Viewport-&gt;<span class="built_in">KeyState</span>(EKeys::RightMouseButton) || <span class="built_in">IsAltDown</span>(Viewport);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((Viewport-&gt;<span class="built_in">IsPenActive</span>() &amp;&amp; Viewport-&gt;<span class="built_in">GetTabletPressure</span>() &gt; <span class="number">0.0f</span>) ||</span><br><span class="line">                (!bMovingCamera &amp;&amp; ViewportClient-&gt;<span class="built_in">GetCurrentWidgetAxis</span>() == EAxisList::None &amp;&amp;</span><br><span class="line">                    ((LandscapeEditorControlType == ELandscapeFoliageEditorControlType::IgnoreCtrl) ||</span><br><span class="line">                     (LandscapeEditorControlType == ELandscapeFoliageEditorControlType::RequireCtrl   &amp;&amp; <span class="built_in">IsCtrlDown</span>(Viewport)) ||</span><br><span class="line">                     (LandscapeEditorControlType == ELandscapeFoliageEditorControlType::RequireNoCtrl &amp;&amp; !<span class="built_in">IsCtrlDown</span>(Viewport)))))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (CurrentTool &amp;&amp; (CurrentTool-&gt;<span class="built_in">GetSupportedTargetTypes</span>() == ELandscapeToolTargetTypeMask::NA || CurrentToolTarget.TargetType != ELandscapeToolTargetType::Invalid))</span><br><span class="line">                &#123;</span><br><span class="line">                    FVector HitLocation;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">LandscapeMouseTrace</span>(ViewportClient, HitLocation))</span><br><span class="line">                    &#123;</span><br><span class="line">                        ...</span><br><span class="line">                            </span><br><span class="line">                        <span class="keyword">if</span> (CurrentTool-&gt;<span class="built_in">CanToolBeActivated</span>())</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="type">bool</span> bToolActive = CurrentTool-&gt;<span class="built_in">BeginTool</span>(ViewportClient, CurrentToolTarget, HitLocation);</span><br><span class="line">                            <span class="keyword">if</span> (bToolActive)</span><br><span class="line">                            &#123;</span><br><span class="line">                                ToolActiveViewport = Viewport;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                            &#123;</span><br><span class="line">                                ToolActiveViewport = <span class="literal">nullptr</span>;</span><br><span class="line">                                Viewport-&gt;<span class="built_in">CaptureMouse</span>(<span class="literal">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            ViewportClient-&gt;<span class="built_in">Invalidate</span>(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">                            <span class="keyword">return</span> bToolActive;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 检测用户松开鼠标的事件</span></span><br><span class="line">        <span class="keyword">if</span> (Key == EKeys::LeftMouseButton ||</span><br><span class="line">            (LandscapeEditorControlType == ELandscapeFoliageEditorControlType::RequireCtrl &amp;&amp; (Key == EKeys::LeftControl || Key == EKeys::RightControl)))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (Event == IE_Released &amp;&amp; CurrentTool &amp;&amp; CurrentTool-&gt;<span class="built_in">IsToolActive</span>() &amp;&amp; ToolActiveViewport)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Set the cursor position to that of the slate cursor so it wont snap back</span></span><br><span class="line">                Viewport-&gt;<span class="built_in">SetPreCaptureMousePosFromSlateCursor</span>();</span><br><span class="line">                CurrentTool-&gt;<span class="built_in">EndTool</span>(ViewportClient);</span><br><span class="line">                Viewport-&gt;<span class="built_in">CaptureMouse</span>(<span class="literal">false</span>);</span><br><span class="line">                ToolActiveViewport = <span class="literal">nullptr</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，在<code>InputKey</code>中，主要检测了两类事件：用户按下鼠标左键以及用户松开鼠标左键。在用户按下左键并检查通过一系列状态设置后，Landscape Editor会调用当前选中的Landscape工具的<code>BeginTool</code>将工具切换为激活状态。而在用户松开左键时，Landscape Editor则会调用<code>EndTool</code> 结束工具的激活状态。</p>
<p>以Sculpt工具为例，其<code>BeginTool</code>，<code>Tick</code>以及<code>EndTool</code>的定义如下片段所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdModeTools.h line 1380</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">BeginTool</span><span class="params">(FEditorViewportClient* ViewportClient, <span class="type">const</span> FLandscapeToolTarget&amp; InTarget, <span class="type">const</span> FVector&amp; InHitLocation)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">IsToolActive</span>() )</span><br><span class="line">    &#123;</span><br><span class="line">        ToolStroke.<span class="built_in">Emplace</span>( EdMode, ViewportClient, InTarget );</span><br><span class="line">        EdMode-&gt;CurrentBrush-&gt;<span class="built_in">BeginStroke</span>( InHitLocation.X, InHitLocation.Y, <span class="keyword">this</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Save the mouse position</span></span><br><span class="line">    LastInteractorPosition = <span class="built_in">FVector2D</span>(InHitLocation);</span><br><span class="line">    InteractorPositions.<span class="built_in">Emplace</span>(LastInteractorPosition, ViewportClient ? <span class="built_in">IsModifierPressed</span>(ViewportClient) : <span class="literal">false</span>); <span class="comment">// Copy tool sometimes activates without a specific viewport via ctrl+c hotkey</span></span><br><span class="line">    TimeSinceLastInteractorMove = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">    ToolStroke-&gt;<span class="built_in">Apply</span>(ViewportClient, EdMode-&gt;CurrentBrush, EdMode-&gt;UISettings, InteractorPositions);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdModeTools.h line 1415</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Tick</span><span class="params">(FEditorViewportClient* ViewportClient, <span class="type">float</span> DeltaTime)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsToolActive</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (InteractorPositions.<span class="built_in">Num</span>() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ToolStroke-&gt;<span class="built_in">Apply</span>(ViewportClient, EdMode-&gt;CurrentBrush, EdMode-&gt;UISettings, InteractorPositions);</span><br><span class="line">            ViewportClient-&gt;<span class="built_in">Invalidate</span>(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            InteractorPositions.<span class="built_in">Empty</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (TStrokeClass::UseContinuousApply &amp;&amp; TimeSinceLastInteractorMove &gt;= <span class="number">0.25f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            InteractorPositions.<span class="built_in">Emplace</span>(LastInteractorPosition, <span class="built_in">IsModifierPressed</span>(ViewportClient));</span><br><span class="line">            ToolStroke-&gt;<span class="built_in">Apply</span>(ViewportClient, EdMode-&gt;CurrentBrush, EdMode-&gt;UISettings, InteractorPositions);</span><br><span class="line">            ViewportClient-&gt;<span class="built_in">Invalidate</span>(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">            InteractorPositions.<span class="built_in">Empty</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        TimeSinceLastInteractorMove += DeltaTime;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdModeTools.h line 1448</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">EndTool</span><span class="params">(FEditorViewportClient* ViewportClient)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">IsToolActive</span>() &amp;&amp; InteractorPositions.<span class="built_in">Num</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        ToolStroke-&gt;<span class="built_in">Apply</span>(ViewportClient, EdMode-&gt;CurrentBrush, EdMode-&gt;UISettings, InteractorPositions);</span><br><span class="line">        InteractorPositions.<span class="built_in">Empty</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ToolStroke.<span class="built_in">Reset</span>();</span><br><span class="line">    EdMode-&gt;CurrentBrush-&gt;<span class="built_in">EndStroke</span>();</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">MouseMove</span><span class="params">(FEditorViewportClient* ViewportClient, FViewport* Viewport, int32 x, int32 y)</span> <span class="keyword">override</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ViewportClient != <span class="literal">nullptr</span> &amp;&amp; Viewport != <span class="literal">nullptr</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        FVector HitLocation;</span><br><span class="line">        <span class="keyword">if</span> (EdMode-&gt;<span class="built_in">LandscapeMouseTrace</span>(ViewportClient, x, y, HitLocation))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// If we are moving the mouse to adjust the brush size, don&#x27;t move the brush</span></span><br><span class="line">            <span class="keyword">if</span> (EdMode-&gt;CurrentBrush &amp;&amp; !EdMode-&gt;<span class="built_in">IsAdjustingBrush</span>(Viewport))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Inform the brush of the current location, to update the cursor</span></span><br><span class="line">                EdMode-&gt;CurrentBrush-&gt;<span class="built_in">MouseMove</span>(HitLocation.X, HitLocation.Y);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">IsToolActive</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Save the interactor position</span></span><br><span class="line">                <span class="keyword">if</span> (InteractorPositions.<span class="built_in">Num</span>() == <span class="number">0</span> || LastInteractorPosition != <span class="built_in">FVector2D</span>(HitLocation))</span><br><span class="line">                &#123;</span><br><span class="line">                    LastInteractorPosition = <span class="built_in">FVector2D</span>(HitLocation);</span><br><span class="line">                    InteractorPositions.<span class="built_in">Emplace</span>(LastInteractorPosition, <span class="built_in">IsModifierPressed</span>(ViewportClient));</span><br><span class="line">                &#125;</span><br><span class="line">                TimeSinceLastInteractorMove = <span class="number">0.0f</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> FVector2D <span class="built_in">NewPosition</span>(x, y);</span><br><span class="line">        <span class="keyword">if</span> (InteractorPositions.<span class="built_in">Num</span>() == <span class="number">0</span> || LastInteractorPosition != <span class="built_in">FVector2D</span>(NewPosition))</span><br><span class="line">        &#123;</span><br><span class="line">            LastInteractorPosition = <span class="built_in">FVector2D</span>(NewPosition);</span><br><span class="line">            InteractorPositions.<span class="built_in">Emplace</span>(LastInteractorPosition, <span class="built_in">IsModifierPressed</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        TimeSinceLastInteractorMove = <span class="number">0.0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，在Sculpt Tool激活的状态下，会收集当前鼠标的位置记录在<code>InterationPositions</code>数组中，并调用笔刷对象的Apply函数更新地形内容。</p>
<p>Sculpt工具使用的笔刷为<code>FLandscapeToolStrokeSculpt</code> ，其<code>Apply</code>的实现如下所示。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdModePaintTools.cpp line 424</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Apply</span><span class="params">(FEditorViewportClient* ViewportClient, FLandscapeBrush* Brush, <span class="type">const</span> ULandscapeEditorObject* UISettings, <span class="type">const</span> TArray&lt;FLandscapeToolInteractorPosition&gt;&amp; InteractorPositions)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    int32 X1, Y1, X2, Y2;</span><br><span class="line">    BrushInfo.<span class="built_in">GetInclusiveBounds</span>(X1, Y1, X2, Y2);</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// expand the area by one vertex in each direction to ensure normals are calculated correctly</span></span><br><span class="line">    X1 -= <span class="number">1</span>;</span><br><span class="line">    Y1 -= <span class="number">1</span>;</span><br><span class="line">    X2 += <span class="number">1</span>;</span><br><span class="line">    Y2 += <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">this</span>-&gt;Cache.<span class="built_in">CacheData</span>(X1, Y1, X2, Y2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The data we&#x27;ll be writing to</span></span><br><span class="line">    TArray&lt;ToolTarget::CacheClass::DataType&gt; Data;</span><br><span class="line">    <span class="keyword">this</span>-&gt;Cache.<span class="built_in">GetCachedData</span>(X1, Y1, X2, Y2, Data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算利用好笔刷更新后的数据</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>-&gt;Cache.<span class="built_in">SetCachedData</span>(X1, Y1, X2, Y2, Data);</span><br><span class="line">    <span class="keyword">this</span>-&gt;Cache.<span class="built_in">Flush</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>FLandscapeToolStrokeSculpt</code> 中，首先根据BrushInfo计算当前笔刷对应的地形区域范围，接着利用<code>Cache::CacheData</code> 将数据读取到内存中。随后，经过计算，将更新后的数据写回到Cache中并Flush到Component中。</p>
<p><code>FLandscapeToolStrokeSculpt</code> 使用的Cache类型为<code>FLandscapeHeightCache</code>， 其<code>CacheData</code>,<code>SetCacheData</code>以及<code>Flush</code>的实现为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdModeTools.h line 297</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CacheData</span><span class="params">(int32 X1, int32 Y1, int32 X2, int32 Y2, <span class="type">bool</span> bCacheOriginalData = <span class="literal">false</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!Valid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Accessor::bUseInterp)</span><br><span class="line">        &#123;</span><br><span class="line">            ValidX1 = CachedX1 = X1;</span><br><span class="line">            ValidY1 = CachedY1 = Y1;</span><br><span class="line">            ValidX2 = CachedX2 = X2;</span><br><span class="line">            ValidY2 = CachedY2 = Y2;</span><br><span class="line"></span><br><span class="line">            DataAccess.<span class="built_in">GetData</span>(ValidX1, ValidY1, ValidX2, ValidY2, CachedData);</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">ensureMsgf</span>(ValidX1 &lt;= ValidX2 &amp;&amp; ValidY1 &lt;= ValidY2, <span class="built_in">TEXT</span>(<span class="string">&quot;Invalid cache area: X(%d-%d), Y(%d-%d) from region X(%d-%d), Y(%d-%d)&quot;</span>), ValidX1, ValidX2, ValidY1, ValidY2, X1, X2, Y1, Y2))</span><br><span class="line">            &#123;</span><br><span class="line">                Valid = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">            </span><br><span class="line">        Valid = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 关于拓展Cache数据区域的相关操作</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdModeTools.h line 557</span></span><br><span class="line"><span class="type">void</span> <span class="built_in">SetCachedData</span>(int32 X1, int32 Y1, int32 X2, int32 Y2, TArray&lt;AccessorType&gt;&amp; Data, ELandscapeLayerPaintingRestriction PaintingRestriction = ELandscapeLayerPaintingRestriction::None, <span class="type">bool</span> bUpdateData = <span class="literal">true</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">checkSlow</span>(Data.<span class="built_in">Num</span>() == (<span class="number">1</span> + Y2 - Y1) * (<span class="number">1</span> + X2 - X1));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update cache</span></span><br><span class="line">    <span class="keyword">for</span> (int32 Y = Y1; Y &lt;= Y2; Y++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (int32 X = X1; X &lt;= X2; X++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">SetValue</span>(X, Y, Data[(X - X1) + (Y - Y1)*(<span class="number">1</span> + X2 - X1)]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bUpdateData)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Update real data</span></span><br><span class="line">        DataAccess.<span class="built_in">SetData</span>(X1, Y1, X2, Y2, Data.<span class="built_in">GetData</span>(), PaintingRestriction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LandscapeEditor\LandscapeEdModeTools.h line 598</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Flush</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DataAccess.<span class="built_in">Flush</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，<code>CacheData</code> 通过<code>Accessor</code> 获取对应区域的数据并缓存到本地数组<code>CachedData</code>中。而用户可以通过<code>SetCachedData</code> 更新本地的<code>CachedData</code> 数组。最后，用户需要调用<code>Flush</code> 使Accessor更新数据。 </p>
<p><code>FHeightmapAccessor</code> 的<code>SetData</code>以及<code>Flush</code>接口的实现如下所示。可以看到，<code>FHeightmapAccessor</code>的<code>SetData</code>以及<code>Flush</code>接口均由<code>FLandscapeEditDataInterface</code> 类型的对象<code>LandscapeEdit</code> 间接完成。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Landscape\LandscapeEdit.h 408</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetData</span><span class="params">(int32 X1, int32 Y1, int32 X2, int32 Y2, <span class="type">const</span> uint16* Data, ELandscapeLayerPaintingRestriction PaintingRestriction = ELandscapeLayerPaintingRestriction::None)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TSet&lt;ULandscapeComponent*&gt; Components;</span><br><span class="line">    <span class="keyword">if</span> (LandscapeInfo &amp;&amp; LandscapeEdit-&gt;<span class="built_in">GetComponentsInRegion</span>(X1, Y1, X2, Y2, &amp;Components))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Update data</span></span><br><span class="line">        ChangedComponents.<span class="built_in">Append</span>(Components);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (ULandscapeComponent* Component : Components)</span><br><span class="line">        &#123;</span><br><span class="line">            Component-&gt;<span class="built_in">RequestHeightmapUpdate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">                    </span><br><span class="line">        <span class="comment">// Notify foliage to move any attached instances</span></span><br><span class="line">        <span class="type">bool</span> bUpdateFoliage = <span class="literal">false</span>;</span><br><span class="line">        <span class="type">bool</span> bUpdateNormals = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查当前对地形的修改是否影响到植被系统</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bUpdateFoliage)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 若影响到植被系统，则</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// No foliage, just update landscape.</span></span><br><span class="line">            LandscapeEdit-&gt;<span class="built_in">SetHeightData</span>(X1, Y1, X2, Y2, Data, <span class="number">0</span>, bUpdateNormals);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Landscape\LandscapeEdit.h 478 </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Flush</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LandscapeEdit-&gt;<span class="built_in">Flush</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FLandscapeEditDataInterface</code> 在Accessor内部由Edit Mode传入的<code>ULandscapeInfo</code> 构造，其负责具体的数据更新的逻辑。其<code>SetHeightData</code>接口以及<code>Flush</code>接口的实现如下所示。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Landscape\LandscapeEditInterface.cpp line 221</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FLandscapeEditDataInterface::SetHeightData</span><span class="params">(int32 X1, int32 Y1, int32 X2, int32 Y2, <span class="type">const</span> uint16* InData, int32 InStride, <span class="type">bool</span> InCalcNormals, <span class="type">const</span> uint16* InNormalData, <span class="type">const</span> uint16* InHeightAlphaBlendData, <span class="type">const</span> uint8* InHeightFlagsData, <span class="type">bool</span> InCreateComponents, UTexture2D* InHeightmap, UTexture2D* InXYOffsetmapTexture,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="type">bool</span> InUpdateBounds, <span class="type">bool</span> InUpdateCollision, <span class="type">bool</span> InGenerateMips)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> int32 NumVertsX = <span class="number">1</span> + X2 - X1;</span><br><span class="line">    <span class="type">const</span> int32 NumVertsY = <span class="number">1</span> + Y2 - Y1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (InStride == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        InStride = NumVertsX;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">check</span>(ComponentSizeQuads &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 计算需要更新的区域覆盖的Component范围</span></span><br><span class="line">    <span class="comment">// Find component range for this block of data</span></span><br><span class="line">    int32 ComponentIndexX1, ComponentIndexY1, ComponentIndexX2, ComponentIndexY2;</span><br><span class="line">    ALandscape::<span class="built_in">CalcComponentIndicesOverlap</span>(X1, Y1, X2, Y2, ComponentSizeQuads, ComponentIndexX1, ComponentIndexY1, ComponentIndexX2, ComponentIndexY2);</span><br><span class="line"></span><br><span class="line">    FVector* VertexNormals = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> (InCalcNormals)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 重新计算法线</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 逐个Component更新数据</span></span><br><span class="line">    <span class="keyword">for</span> (int32 ComponentIndexY = ComponentIndexY1; ComponentIndexY &lt;= ComponentIndexY2; ComponentIndexY++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (int32 ComponentIndexX = ComponentIndexX1; ComponentIndexX &lt;= ComponentIndexX2; ComponentIndexX++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="function">FIntPoint <span class="title">ComponentKey</span><span class="params">(ComponentIndexX, ComponentIndexY)</span></span>;</span><br><span class="line">            ULandscapeComponent* Component = LandscapeInfo-&gt;XYtoComponentMap.<span class="built_in">FindRef</span>(ComponentKey);</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            UTexture2D* Heightmap = InHeightmap != <span class="literal">nullptr</span> ? InHeightmap : Component-&gt;<span class="built_in">GetHeightmap</span>(<span class="literal">true</span>);</span><br><span class="line">            UTexture2D* XYOffsetmapTexture = InXYOffsetmapTexture != <span class="literal">nullptr</span> ? InXYOffsetmapTexture : Component-&gt;XYOffsetmapTexture;</span><br><span class="line"></span><br><span class="line">            Component-&gt;<span class="built_in">Modify</span>(<span class="built_in">GetShouldDirtyPackage</span>());</span><br><span class="line"></span><br><span class="line">            FLandscapeTextureDataInfo* TexDataInfo = <span class="built_in">GetTextureDataInfo</span>(Heightmap);</span><br><span class="line">            FColor* HeightmapTextureData = (FColor*)TexDataInfo-&gt;<span class="built_in">GetMipData</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Find the texture data corresponding to this vertex</span></span><br><span class="line">            int32 SizeU = Heightmap-&gt;Source.<span class="built_in">GetSizeX</span>();</span><br><span class="line">            int32 SizeV = Heightmap-&gt;Source.<span class="built_in">GetSizeY</span>();</span><br><span class="line">            int32 HeightmapOffsetX = Component-&gt;HeightmapScaleBias.Z * (<span class="type">float</span>)SizeU;</span><br><span class="line">            int32 HeightmapOffsetY = Component-&gt;HeightmapScaleBias.W * (<span class="type">float</span>)SizeV;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Find coordinates of box that lies inside component</span></span><br><span class="line">            int32 ComponentX1 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;(X1 - ComponentIndexX*ComponentSizeQuads, <span class="number">0</span>, ComponentSizeQuads);</span><br><span class="line">            int32 ComponentY1 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;(Y1 - ComponentIndexY*ComponentSizeQuads, <span class="number">0</span>, ComponentSizeQuads);</span><br><span class="line">            int32 ComponentX2 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;(X2 - ComponentIndexX*ComponentSizeQuads, <span class="number">0</span>, ComponentSizeQuads);</span><br><span class="line">            int32 ComponentY2 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;(Y2 - ComponentIndexY*ComponentSizeQuads, <span class="number">0</span>, ComponentSizeQuads);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Find subsection range for this box</span></span><br><span class="line">            int32 SubIndexX1 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;((ComponentX1 - <span class="number">1</span>) / SubsectionSizeQuads, <span class="number">0</span>, ComponentNumSubsections - <span class="number">1</span>);    <span class="comment">// -1 because we need to pick up vertices shared between subsections</span></span><br><span class="line">            int32 SubIndexY1 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;((ComponentY1 - <span class="number">1</span>) / SubsectionSizeQuads, <span class="number">0</span>, ComponentNumSubsections - <span class="number">1</span>);</span><br><span class="line">            int32 SubIndexX2 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;(ComponentX2 / SubsectionSizeQuads, <span class="number">0</span>, ComponentNumSubsections - <span class="number">1</span>);</span><br><span class="line">            int32 SubIndexY2 = FMath::<span class="built_in">Clamp</span>&lt;int32&gt;(ComponentY2 / SubsectionSizeQuads, <span class="number">0</span>, ComponentNumSubsections - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// To adjust bounding box</span></span><br><span class="line">            uint16 MinHeight = MAX_uint16;</span><br><span class="line">            uint16 MaxHeight = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (int32 SubIndexY = SubIndexY1; SubIndexY &lt;= SubIndexY2; SubIndexY++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">for</span> (int32 SubIndexX = SubIndexX1; SubIndexX &lt;= SubIndexX2; SubIndexX++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 计算各个Section内需要更新的区域并执行实际的数据更新操作</span></span><br><span class="line">                    ...</span><br><span class="line">                        </span><br><span class="line">                    <span class="comment">// Record the areas of the texture we need to re-upload</span></span><br><span class="line">                    int32 TexX1 = HeightmapOffsetX + (SubsectionSizeQuads + <span class="number">1</span>) * SubIndexX + SubX1;</span><br><span class="line">                    int32 TexY1 = HeightmapOffsetY + (SubsectionSizeQuads + <span class="number">1</span>) * SubIndexY + SubY1;</span><br><span class="line">                    int32 TexX2 = HeightmapOffsetX + (SubsectionSizeQuads + <span class="number">1</span>) * SubIndexX + SubX2;</span><br><span class="line">                    int32 TexY2 = HeightmapOffsetY + (SubsectionSizeQuads + <span class="number">1</span>) * SubIndexY + SubY2;</span><br><span class="line">                    TexDataInfo-&gt;<span class="built_in">AddMipUpdateRegion</span>(<span class="number">0</span>, TexX1, TexY1, TexX2, TexY2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">                                                </span><br><span class="line">            Component-&gt;<span class="built_in">RequestHeightmapUpdate</span>();</span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Update GUID for Platform Data</span></span><br><span class="line">            FPlatformMisc::<span class="built_in">CreateGuid</span>(Component-&gt;StateId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (VertexNormals)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span>[] VertexNormals;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">x <span class="comment">// Landscape\LandscapeEditInterface.cpp line 54</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FLandscapeTextureDataInterface::Flush</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">bool</span> bNeedToWaitForUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bUploadTextureChangesToGPU)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Update all textures</span></span><br><span class="line">        <span class="keyword">for</span> (TMap&lt;UTexture2D*, FLandscapeTextureDataInfo*&gt;::TIterator <span class="built_in">It</span>(TextureDataMap); It; ++It)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (It.<span class="built_in">Value</span>()-&gt;<span class="built_in">UpdateTextureData</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                bNeedToWaitForUpdate = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( bNeedToWaitForUpdate )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">FlushRenderingCommands</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delete all the FLandscapeTextureDataInfo allocations</span></span><br><span class="line">    <span class="keyword">for</span>( TMap&lt;UTexture2D*, FLandscapeTextureDataInfo*&gt;::TIterator <span class="built_in">It</span>(TextureDataMap); It;  ++It )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> It.<span class="built_in">Value</span>();  <span class="comment">// FLandscapeTextureDataInfo destructors will unlock any texture data</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TextureDataMap.<span class="built_in">Empty</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，在<code>SetHeightData</code> 中会计算更新区域覆盖Component的范围，并将数据写入到对应的height map的纹理缓冲区中。而在<code>Flush</code> 中会生成并执行更新纹理的渲染命令，并清空临时缓冲区，从而完成画面中地形顶点位置的更新。</p>
<h4 id="4-小结"><a href="#4-小结" class="headerlink" title="4. 小结"></a>4. 小结</h4><p>本文从UE地编系统的基础操作出发，介绍了地编系统的代码结构以及地形数据更新的流程。由于本文目标旨在整体代码结构介绍，因此对于地形编辑系统的具体算法（顶点的更新算法、被影响植被位置的更新算法、地形的渲染等）未作讨论，这可能在后续的文章中详细展开。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">tzn</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/06/26/UE-terrain-1/">http://example.com/2025/06/26/UE-terrain-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">tzn的小窝</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/render-UE/">render UE</a></div><div class="post_share"><div class="social-share" data-image="/images/ia1.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2025/05/13/mat-cook-torrance/" title="再探PBR--微表面模型"><img class="cover" src="/images/kyky.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">再探PBR--微表面模型</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/images/ranran0.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">tzn</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">6</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tzn893"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">tzn的笔记杂物间, 以后可能会写点有杂谈发电在这里捏</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%9C%B0%E7%BC%96%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.</span> <span class="toc-text">1. 地编系统的基本操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%9C%B0%E7%BC%96%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">2. 地编系统的源码结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%9C%B0%E7%BC%96%E7%B3%BB%E7%BB%9F%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE%E6%B5%81"><span class="toc-number">3.</span> <span class="toc-text">3.地编系统中的数据流</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E5%B0%8F%E7%BB%93"><span class="toc-number">4.</span> <span class="toc-text">4. 小结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/06/26/UE-terrain-1/" title="UE4中的地形以及植被系统(1)--地形的编辑"><img src="/images/ia1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="UE4中的地形以及植被系统(1)--地形的编辑"/></a><div class="content"><a class="title" href="/2025/06/26/UE-terrain-1/" title="UE4中的地形以及植被系统(1)--地形的编辑">UE4中的地形以及植被系统(1)--地形的编辑</a><time datetime="2025-06-26T02:03:14.000Z" title="发表于 2025-06-26 10:03:14">2025-06-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/05/13/mat-cook-torrance/" title="再探PBR--微表面模型"><img src="/images/kyky.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="再探PBR--微表面模型"/></a><div class="content"><a class="title" href="/2025/05/13/mat-cook-torrance/" title="再探PBR--微表面模型">再探PBR--微表面模型</a><time datetime="2025-05-13T01:58:37.000Z" title="发表于 2025-05-13 09:58:37">2025-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/25/Volume2/" title="再探体渲染(二)--Ray Marching 从理论到实现"><img src="/images/kiki0.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="再探体渲染(二)--Ray Marching 从理论到实现"/></a><div class="content"><a class="title" href="/2024/10/25/Volume2/" title="再探体渲染(二)--Ray Marching 从理论到实现">再探体渲染(二)--Ray Marching 从理论到实现</a><time datetime="2024-10-25T13:35:57.000Z" title="发表于 2024-10-25 21:35:57">2024-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/22/VolumeRender1/" title="再探体渲染（一）-- 理论"><img src="/images/misc0.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="再探体渲染（一）-- 理论"/></a><div class="content"><a class="title" href="/2024/10/22/VolumeRender1/" title="再探体渲染（一）-- 理论">再探体渲染（一）-- 理论</a><time datetime="2024-10-22T15:08:24.000Z" title="发表于 2024-10-22 23:08:24">2024-10-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/06/13/Interview/" title="校招面试题汇总"><img src="/images/mika1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="校招面试题汇总"/></a><div class="content"><a class="title" href="/2024/06/13/Interview/" title="校招面试题汇总">校招面试题汇总</a><time datetime="2024-06-13T06:52:33.000Z" title="发表于 2024-06-13 14:52:33">2024-06-13</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By tzn</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>